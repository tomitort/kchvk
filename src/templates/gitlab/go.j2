stages:
  - build
  - test
  - code_analysis
  - docker_build
  - publish
  - deploy_staging
  - deploy_production

variables:
  PROJECT_NAME: "{{ project_name }}"
  DOCKER_REGISTRY: "{{ docker_registry }}"
  GO111MODULE: "on"

.build_template: &build_template
  stage: build
  script:
    - echo "Building $PROJECT_NAME..."
    - go mod download
    - go build -o $PROJECT_NAME ./cmd/$PROJECT_NAME
  artifacts:
    paths:
      - $PROJECT_NAME
    expire_in: 1 week

.test_template: &test_template
  stage: test
  script:
    - echo "Running tests..."
    - go test -v ./... -short
  artifacts:
    reports:
      junit:
        - test-results/*.xml

.code_analysis_template: &code_analysis_template
  stage: code_analysis
  script:
    - echo "Running code analysis with SonarQube..."
    - go test -coverprofile=coverage.out ./...
    - sonar-scanner -Dsonar.projectKey=$PROJECT_NAME -Dsonar.go.coverage.reportPaths=coverage.out

.docker_build_template: &docker_build_template
  stage: docker_build
  script:
    - echo "Building Docker image..."
    - docker build -t $PROJECT_NAME:$CI_COMMIT_SHA .
    - docker tag $PROJECT_NAME:$CI_COMMIT_SHA $DOCKER_REGISTRY/$PROJECT_NAME:$CI_COMMIT_SHA

.publish_template: &publish_template
  stage: publish
  script:
    - echo "Publishing artifacts..."
    - docker push $DOCKER_REGISTRY/$PROJECT_NAME:$CI_COMMIT_SHA

.deploy_staging_template: &deploy_staging_template
  stage: deploy_staging
  script:
    - echo "Deploying to staging environment..."
    - kubectl set image deployment/$PROJECT_NAME $PROJECT_NAME=$DOCKER_REGISTRY/$PROJECT_NAME:$CI_COMMIT_SHA -n staging
  only:
    - develop

.deploy_production_template: &deploy_production_template
  stage: deploy_production
  script:
    - echo "Deploying to production environment..."
    - kubectl set image deployment/$PROJECT_NAME $PROJECT_NAME=$DOCKER_REGISTRY/$PROJECT_NAME:$CI_COMMIT_SHA -n production
  only:
    - main

build:
  <<: *build_template

unit_tests:
  <<: *test_template
  script:
    - echo "Running unit tests..."
    - go test -v ./... -short

integration_tests:
  <<: *test_template
  script:
    - echo "Running integration tests..."
    - go test -v ./... -tags=integration

code_analysis:
  <<: *code_analysis_template

docker_build:
  <<: *docker_build_template

publish:
  <<: *publish_template
  dependencies:
    - build
    - unit_tests
    - integration_tests

deploy_staging:
  <<: *deploy_staging_template
  dependencies:
    - publish

deploy_production:
  <<: *deploy_production_template
  dependencies:
    - publish

cache:
  paths:
    - go/pkg/mod