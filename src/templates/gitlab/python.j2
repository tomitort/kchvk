stages:
  - build
  - test
  - code_analysis
  - docker_build
  - publish
  - deploy_staging
  - deploy_production

variables:
  PROJECT_NAME: "{{ project_name }}"
  DOCKER_REGISTRY: "{{ docker_registry }}"

.build_template: &build_template
  stage: build
  script:
    - echo "Building $PROJECT_NAME..."
    {% if build_tool == "poetry" %}
    - poetry install --no-dev
    - poetry build
    {% elif build_tool == "pipenv" %}
    - pipenv install --deploy
    - pipenv run python setup.py build
    {% else %}
    - pip install -r requirements.txt
    - python setup.py build
    {% endif %}
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

.test_template: &test_template
  stage: test
  script:
    - echo "Running tests..."
    {% if build_tool == "poetry" %}
    - poetry run pytest tests/unit -v --junitxml=test-results/unit.xml
    {% elif build_tool == "pipenv" %}
    - pipenv run pytest tests/unit -v --junitxml=test-results/unit.xml
    {% else %}
    - pytest tests/unit -v --junitxml=test-results/unit.xml
    {% endif %}
  artifacts:
    reports:
      junit:
        - test-results/unit.xml

.code_analysis_template: &code_analysis_template
  stage: code_analysis
  script:
    - echo "Running code analysis with SonarQube..."
    {% if build_tool == "poetry" %}
    - poetry run coverage run -m pytest
    - poetry run coverage xml
    {% elif build_tool == "pipenv" %}
    - pipenv run coverage run -m pytest
    - pipenv run coverage xml
    {% else %}
    - coverage run -m pytest
    - coverage xml
    {% endif %}
    - sonar-scanner -Dsonar.projectKey=$PROJECT_NAME -Dsonar.python.coverage.reportPaths=coverage.xml

.docker_build_template: &docker_build_template
  stage: docker_build
  script:
    - echo "Building Docker image..."
    - docker build -t $PROJECT_NAME:$CI_COMMIT_SHA .
    - docker tag $PROJECT_NAME:$CI_COMMIT_SHA $DOCKER_REGISTRY/$PROJECT_NAME:$CI_COMMIT_SHA

.publish_template: &publish_template
  stage: publish
  script:
    - echo "Publishing artifacts..."
    {% if build_tool == "poetry" %}
    - poetry publish --username $NEXUS_USERNAME --password $NEXUS_PASSWORD
    {% elif build_tool == "pipenv" %}
    - pipenv run twine upload dist/* --username $NEXUS_USERNAME --password $NEXUS_PASSWORD
    {% else %}
    - twine upload dist/* --username $NEXUS_USERNAME --password $NEXUS_PASSWORD
    {% endif %}
    - docker push $DOCKER_REGISTRY/$PROJECT_NAME:$CI_COMMIT_SHA

.deploy_staging_template: &deploy_staging_template
  stage: deploy_staging
  script:
    - echo "Deploying to staging environment..."
    - kubectl set image deployment/$PROJECT_NAME $PROJECT_NAME=$DOCKER_REGISTRY/$PROJECT_NAME:$CI_COMMIT_SHA -n staging
  only:
    - develop

.deploy_production_template: &deploy_production_template
  stage: deploy_production
  script:
    - echo "Deploying to production environment..."
    - kubectl set image deployment/$PROJECT_NAME $PROJECT_NAME=$DOCKER_REGISTRY/$PROJECT_NAME:$CI_COMMIT_SHA -n production
  only:
    - main

build:
  <<: *build_template

unit_tests:
  <<: *test_template
  script:
    - echo "Running unit tests..."
    {% if build_tool == "poetry" %}
    - poetry run pytest tests/unit -v --junitxml=test-results/unit.xml
    {% elif build_tool == "pipenv" %}
    - pipenv run pytest tests/unit -v --junitxml=test-results/unit.xml
    {% else %}
    - pytest tests/unit -v --junitxml=test-results/unit.xml
    {% endif %}

integration_tests:
  <<: *test_template
  script:
    - echo "Running integration tests..."
    {% if build_tool == "poetry" %}
    - poetry run pytest tests/integration -v --junitxml=test-results/integration.xml
    {% elif build_tool == "pipenv" %}
    - pipenv run pytest tests/integration -v --junitxml=test-results/integration.xml
    {% else %}
    - pytest tests/integration -v --junitxml=test-results/integration.xml
    {% endif %}

code_analysis:
  <<: *code_analysis_template

docker_build:
  <<: *docker_build_template

publish:
  <<: *publish_template
  dependencies:
    - build
    - unit_tests
    - integration_tests

deploy_staging:
  <<: *deploy_staging_template
  dependencies:
    - publish

deploy_production:
  <<: *deploy_production_template
  dependencies:
    - publish

cache:
  paths:
    {% if build_tool == "poetry" %}
    - .venv
    - dist
    {% elif build_tool == "pipenv" %}
    - .venv
    - dist
    {% else %}
    - dist
    {% endif %}